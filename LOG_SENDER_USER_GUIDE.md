# Log-Sender User Guide for System Administrators

## Table of Contents
1. [Overview](#overview)
2. [Installation and Building](#installation-and-building)
3. [Quick Start](#quick-start)
4. [Commands Reference](#commands-reference)
5. [Configuration](#configuration)
6. [Deployment](#deployment)
7. [Security](#security)
8. [Monitoring and Maintenance](#monitoring-and-maintenance)
9. [Troubleshooting](#troubleshooting)
10. [Examples](#examples)

## Overview

**⚠️ IMPORTANT:** Log-Sender is specifically designed for Holochain 0.6.0 conductor environments with reporting enabled. It is not a generic log collection tool.

Log-Sender is a secure log collection agent that monitors JSONL log files generated by Holochain conductors and transmits them to a centralized log-collector service. It provides cryptographic authentication and ensures log integrity through RSA key-based signing.

**Key Features:**
- Automatic registration with log-collector service
- Cryptographic signing of log data
- Specifically designed for Holochain 0.6.0 conductor logs
- Database size reporting for Holochain conductors
- Configurable reporting intervals
- Background service operation

**⚠️ SECURITY WARNING:** Never share or publish your actual Holochain agent keys or RSA private keys. The examples in this guide use placeholder values for demonstration only.

## Installation and Building

### Building from Source

Log-Sender is written in Rust and requires Rust toolchain for building:

```bash
# Clone the repository
git clone <repository-url>
cd log-sender

# Build the application
make all

# The binary will be in target/release/log-sender
ls target/release/log-sender
```

### System Requirements

- **Rust**: Latest stable version
- **Operating System**: Linux (primary target), macOS, Windows
- **Memory**: Minimum 512MB RAM
- **Disk Space**: 100MB for application, additional space for logs
- **Network**: TCP access to log-collector service

## Quick Start

**Prerequisites:**
- Holochain 0.6.0 conductor with reporting enabled
- Access to Holochain agent key (unyt public key)
- Log-collector service endpoint
- Log directories where Holochain conductor writes JSONL files

### 1. Basic Setup

```bash
# Initialize configuration with your log-collector endpoint
# Use your Holochain agent's unyt public key
./log-sender init \
  --config-file /etc/log-sender/config.json \
  --endpoint http://log-collector.example.com:8787 \
  --unyt-pub-key uhCAk... \
  --report-interval-seconds 60 \
  --report-path /var/log/holochain \
  --conductor-config-path /etc/holochain/conductor-config.toml

# Start the service
./log-sender service --config-file /etc/log-sender/config.json
```

### 2. Set Up as System Service

```bash
# Create systemd service file
sudo tee /etc/systemd/system/log-sender.service > /dev/null <<EOF
[Unit]
Description=Log-Sender Service
After=network.target

[Service]
Type=simple
User=log-sender
Group=log-sender
WorkingDirectory=/var/lib/log-sender
ExecStart=/usr/local/bin/log-sender service --config-file /etc/log-sender/config.json
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# Enable and start the service
sudo systemctl enable log-sender
sudo systemctl start log-sender
sudo systemctl status log-sender
```

## Commands Reference

### log-sender init

Initializes a new log-sender configuration, generates cryptographic keys, and registers with the log-collector service.

**Syntax:**
```bash
log-sender init [OPTIONS]
```

**Options:**

| Option | Description | Environment Variable |
|--------|-------------|---------------------|
| `--config-file PATH` | Path to configuration file | `LOG_SENDER_CONFIG_FILE` |
| `--endpoint URL` | Log-collector endpoint URL | `LOG_SENDER_ENDPOINT` |
| `--unyt-pub-key KEY` | Holochain agent public key | `LOG_SENDER_UNYT_PUB_KEY` |
| `--report-interval-seconds SECONDS` | Reporting frequency | `LOG_SENDER_REPORT_INTERVAL_SECONDS` |
| `--report-path PATH` | Log directory path (can be multiple) | `LOG_SENDER_REPORT_PATHS` |
| `--conductor-config-path PATH` | Holochain conductor config (can be multiple) | `LOG_SENDER_CONDUCTOR_CONFIG_PATHS` |

**Example:**
```bash
./log-sender init \
  --config-file /etc/log-sender/config.json \
  --endpoint https://logs.example.com \
  --unyt-pub-key uhCAk... \
  --report-interval-seconds 300 \
  --report-path /var/log/holochain/conductor \
  --report-path /var/log/holochain/apps \
  --conductor-config-path /etc/holochain/conductor-config.toml
```

### log-sender service

Runs the log-sender service in the foreground, monitoring and transmitting logs.

**Syntax:**
```bash
log-sender service [OPTIONS]
```

**Options:**

| Option | Description | Environment Variable |
|--------|-------------|---------------------|
| `--config-file PATH` | Path to configuration file | `LOG_SENDER_CONFIG_FILE` |

**Example:**
```bash
./log-sender service --config-file /etc/log-sender/config.json
```

**Usage Notes:**
- Runs continuously until interrupted
- Monitors configured log directories for new entries
- Automatically processes new .jsonl files
- Implements exponential backoff on connection failures

## Configuration

### Configuration File Structure

The configuration file is in JSON format and contains all settings for log-sender operation:

```json
{
  "endpoint": "http://log-collector:8787",
  "drone_pub_key": "MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQE...",
  "drone_sec_key": "MIIEowIBAAKCAQEA...",
  "unyt_pub_key": "uhCAk...",
  "drone_id": 12345,
  "report_interval_seconds": 60,
  "report_path_list": ["/var/log/holochain/conductor", "/var/log/holochain/apps"],
  "conductor_config_path_list": ["/etc/holochain/conductor-config.toml"],
  "last_record_timestamp": "1758571617392359"
}
```

### Configuration Fields

| Field | Type | Description | Required |
|-------|------|-------------|----------|
| `endpoint` | String | Log-collector service URL | Yes |
| `drone_pub_key` | String | RSA public key (base64 SPKI DER) | Yes (auto-generated) |
| `drone_sec_key` | String | RSA private key (base64 PKCS8 DER) | Yes (auto-generated) |
| `unyt_pub_key` | String | Holochain agent public key (uhCAk...) | Yes |
| `drone_id` | Number | Assigned drone ID from registration | Yes (auto-assigned) |
| `report_interval_seconds` | Number | Seconds between service cycles | Yes |
| `report_path_list` | Array | Log directories where Holochain writes JSONL files | Yes |
| `conductor_config_path_list` | Array | Holochain conductor config files | No |
| `last_record_timestamp` | String | Last processed log timestamp | Yes (auto-managed) |

### Environment Variables

All configuration options can be set via environment variables:

```bash
# Example environment file for Holochain environment
export LOG_SENDER_CONFIG_FILE="/etc/log-sender/config.json"
export LOG_SENDER_ENDPOINT="http://log-collector:8787"
export LOG_SENDER_UNYT_PUB_KEY="uhCAk..."
export LOG_SENDER_REPORT_INTERVAL_SECONDS="300"
export LOG_SENDER_REPORT_PATHS="/var/log/holochain/conductor,/var/log/holochain/apps"
export LOG_SENDER_CONDUCTOR_CONFIG_PATHS="/etc/holochain/conductor-config.toml"
```

### Configuration Best Practices

1. **Secure File Permissions:**
   ```bash
   # Config should be readable only by service user
   chmod 600 /etc/log-sender/config.json
   chown log-sender:log-sender /etc/log-sender/config.json
   ```

2. **Use Environment Variables for Sensitive Data:**
   - Set sensitive values via environment variables when possible
   - Use configuration files for static settings

3. **Regular Key Rotation:**
   - Regenerate keys periodically for security
   - Re-register after key rotation

## Deployment

### Single Server Deployment

For monitoring Holochain conductor logs on a single server:

```bash
# Install log-sender
sudo cp log-sender /usr/local/bin/
sudo chmod +x /usr/local/bin/log-sender

# Create service user
sudo useradd -r -s /bin/false log-sender

# Create Holochain log directories
sudo mkdir -p /var/log/holochain/conductor
sudo mkdir -p /var/log/holochain/apps

# Initialize configuration with Holochain agent key
sudo -u log-sender log-sender init \
  --config-file /etc/log-sender/config.json \
  --endpoint http://log-collector.example.com:8787 \
  --unyt-pub-key uhCAk... \
  --report-interval-seconds 300 \
  --report-path /var/log/holochain/conductor \
  --report-path /var/log/holochain/apps \
  --conductor-config-path /etc/holochain/conductor-config.toml

# Secure configuration
sudo chmod 600 /etc/log-sender/config.json
sudo chown log-sender:log-sender /etc/log-sender/config.json
sudo chown -R log-sender:log-sender /var/log/holochain

# Set up systemd service
sudo systemctl enable log-sender
sudo systemctl start log-sender
```

### Container Deployment

For containerized environments:

```bash
# Docker example for Holochain environment
docker run -d \
  --name log-sender \
  -v /var/log/holochain:/var/log/holochain:ro \
  -v /path/to/config.json:/etc/log-sender/config.json:ro \
  -v /path/to/holochain/config:/etc/holochain:ro \
  -e LOG_SENDER_CONFIG_FILE=/etc/log-sender/config.json \
  --restart unless-stopped \
  log-sender:latest service

# Docker Compose example for Holochain environment
cat > docker-compose.yml <<EOF
version: '3.8'
services:
  log-sender:
    image: log-sender:latest
    volumes:
      - /var/log/holochain:/var/log/holochain:ro
      - ./config.json:/etc/log-sender/config.json:ro
      - ./conductor-config.toml:/etc/holochain/conductor-config.toml:ro
    environment:
      - LOG_SENDER_CONFIG_FILE=/etc/log-sender/config.json
    restart: unless-stopped
    depends_on:
      - log-collector
EOF
```

### Cluster Deployment

For monitoring multiple servers:

1. **Deploy log-sender on each server**
2. **Use same unyt public key across cluster**
3. **Configure different log directories per server**
4. **Use load balancer for log-collector endpoint**

## Security

### Key Management

- **RSA Key Generation**: Keys are automatically generated during initialization
- **Key Format**: Uses SPKI DER format for public keys, PKCS8 DER for private keys
- **Key Storage**: Private keys are stored in configuration file (secure with file permissions)
- **Key Rotation**: Regenerate keys periodically and re-register

### Network Security

- **HTTPS**: Use HTTPS endpoints in production
- **Certificate Validation**: Ensure proper TLS certificate validation
- **Network Isolation**: Restrict log-collector network access to necessary ports
- **Firewall Rules**: Allow outbound connections only to log-collector

### File Security

- **Log File Permissions**: Ensure log files are readable by log-sender user
- **Config File Permissions**: Restrict config file access to service user only
- **Directory Permissions**: Log directories should be readable by service user

### User Management

Create dedicated service user with minimal permissions:

```bash
# Create service user
sudo useradd -r -s /bin/false -d /var/lib/log-sender log-sender

# Set appropriate permissions
sudo chown -R log-sender:log-sender /var/lib/log-sender
sudo chown -R log-sender:log-sender /etc/log-sender
```

## Monitoring and Maintenance

### Service Status

```bash
# Check service status
sudo systemctl status log-sender

# View service logs
sudo journalctl -u log-sender -f

# Check configuration
sudo -u log-sender log-sender service --config-file /etc/log-sender/config.json
```

### Health Monitoring

Log-Sender provides health information through service logs:

```
[INFO] Running Command: Service { ... }
[INFO] Checking DB sizes..
[INFO] Reporting 3 db size proofs..
[INFO] Running reports..
[INFO] Reporting 6 proofs..
[INFO] done.
```

### Performance Monitoring

Key metrics to monitor:

- **Log Processing Rate**: Lines processed per minute
- **Transmission Latency**: Time to send logs to collector
- **Service Uptime**: Continuous operation
- **Error Rates**: Failed transmissions, connection issues

### Log Rotation

Log files should be rotated by your application:

- **Naming Convention**: Files must end with `.jsonl`
- **Rotation Strategy**: Application should rotate and create new files
- **File Permissions**: Ensure rotated files remain readable

## Troubleshooting

### Common Issues

#### Service Won't Start

**Symptoms:**
- Service fails to start
- Configuration errors
- Permission issues

**Solutions:**
```bash
# Check configuration syntax
jq . /etc/log-sender/config.json

# Check file permissions
ls -la /etc/log-sender/config.json
sudo chown log-sender:log-sender /etc/log-sender/config.json
sudo chmod 600 /etc/log-sender/config.json

# Test configuration manually
sudo -u log-sender log-sender service --config-file /etc/log-sender/config.json
```

#### Registration Failures

**Symptoms:**
- Error during initialization
- "Invalid signature" errors
- "Connection refused" errors

**Solutions:**
```bash
# Verify log-collector connectivity
curl -v http://log-collector:8787/

# Check unyt key format
echo $LOG_SENDER_UNYT_PUB_KEY | grep -q "^uhCAk" && echo "Valid format" || echo "Invalid format"

# Check drone key format
jq -r '.drone_pub_key' /etc/log-sender/config.json | grep -q "^MIIB" && echo "Valid drone key" || echo "Invalid drone key"

# Check network connectivity
ping log-collector
telnet log-collector 8787

# Re-initialize configuration
sudo -u log-sender log-sender init --config-file /etc/log-sender/config.json ...
```

#### No Logs Being Transmitted

**Symptoms:**
- Service running but no metrics appearing
- "0 metrics" in logs
- Database shows no new entries

**Solutions:**
```bash
# Check Holochain log directory permissions
ls -la /var/log/holochain/conductor/
sudo chown -R log-sender:log-sender /var/log/holochain/

# Verify Holochain JSONL file format
head -n 5 /var/log/holochain/conductor/*.jsonl | jq .

# Check for Holochain required fields
find /var/log/holochain -name "*.jsonl" -exec grep -E '^{"k":|"t":' {} \; | head -3

# Enable debug logging
RUST_LOG=debug sudo -u log-sender log-sender service --config-file /etc/log-sender/config.json
```

#### Network Connectivity Issues

**Symptoms:**
- Connection timeouts
- DNS resolution failures
- Firewall blocked connections

**Solutions:**
```bash
# Test DNS resolution
nslookup log-collector.example.com

# Test TCP connectivity
nc -zv log-collector.example.com 8787

# Check firewall rules
sudo iptables -L
sudo firewall-cmd --list-all

# Verify endpoint URL
curl -v http://log-collector.example.com:8787/
```

#### Key Format Issues

**Symptoms:**
- "Invalid key format" errors
- Registration signature validation fails

**Solutions:**
- Ensure unyt key starts with "uhCAk"
- Verify drone public key starts with "MIIB" (SPKI DER format)
- Re-generate keys if corrupted

### Debug Logging

Enable debug logging for troubleshooting:

```bash
# Set environment variable
export RUST_LOG=debug

# Run service with debug logging
RUST_LOG=debug sudo -u log-sender log-sender service --config-file /etc/log-sender/config.json

# Enable specific module logging
RUST_LOG=log_sender=debug sudo -u log-sender log-sender service --config-file /etc/log-sender/config.json
```

### Configuration Validation

Validate configuration before deployment:

```bash
# Check JSON syntax
jq . /etc/log-sender/config.json

# Validate required fields
jq 'has("endpoint") and has("drone_pub_key") and has("drone_sec_key")' /etc/log-sender/config.json

# Check key formats
jq -r '.unyt_pub_key' /etc/log-sender/config.json | grep -q "^uhCAk" && echo "Valid unyt key" || echo "Invalid unyt key"
jq -r '.drone_pub_key' /etc/log-sender/config.json | grep -q "^MIIB" && echo "Valid drone key" || echo "Invalid drone key"
```

### Log File Format Issues

Ensure log files meet format requirements:

```json
# Valid Holochain log format examples
{"k":"start","t":"1758571617392359","status":"initialized"}
{"k":"metric","t":"1758571617392360","value":100.5,"source":"conductor"}
{"k":"fetchedOps","t":"1758571617392361","count":150,"latency":42}
```

**Holochain Log Requirements:**
- Each line must be valid JSON
- Must have "k" field (string, log type like "start", "metric", "fetchedOps")
- Must have "t" field (string, microsecond timestamp)
- Common Holochain log types: "start", "fetchedOps", "metric", "error"
- Additional Holochain-specific fields are allowed
- Files must end with `.jsonl` extension
- Files are typically written by Holochain conductor with reporting enabled

## Examples

### Complete Setup Example

```bash
#!/bin/bash
# Complete log-sender setup script for Holochain 0.6.0 conductor environment

set -e

# Configuration (replace with your actual values)
LOG_COLLECTOR_URL="http://log-collector.example.com:8787"
UNYT_PUB_KEY="uhCAk..."
CONFIG_FILE="/etc/log-sender/config.json"
SERVICE_USER="log-sender"

# Create service user
sudo useradd -r -s /bin/false -d /var/lib/log-sender $SERVICE_USER

# Create Holochain-specific directories
sudo mkdir -p /etc/log-sender
sudo mkdir -p /var/lib/log-sender
sudo mkdir -p /var/log/holochain/conductor
sudo mkdir -p /var/log/holochain/apps

# Install log-sender binary
sudo cp log-sender /usr/local/bin/
sudo chmod +x /usr/local/bin/log-sender

# Initialize configuration with Holochain conductor settings
sudo -u $SERVICE_USER log-sender init \
  --config-file $CONFIG_FILE \
  --endpoint $LOG_COLLECTOR_URL \
  --unyt-pub-key $UNYT_PUB_KEY \
  --report-interval-seconds 300 \
  --report-path /var/log/holochain/conductor \
  --report-path /var/log/holochain/apps \
  --conductor-config-path /etc/holochain/conductor-config.toml

# Set permissions
sudo chmod 600 $CONFIG_FILE
sudo chown $SERVICE_USER:$SERVICE_USER $CONFIG_FILE
sudo chown -R $SERVICE_USER:$SERVICE_USER /var/lib/log-sender
sudo chown -R $SERVICE_USER:$SERVICE_USER /var/log/holochain

# Create test log files (Holochain format)
echo '{"k":"start","t":"1758571617392359","component":"holochain_conductor"}' | sudo tee /var/log/holochain/conductor/test.jsonl

# Create systemd service
sudo tee /etc/systemd/system/log-sender.service > /dev/null <<EOF
[Unit]
Description=Log-Sender Service
After=network.target

[Service]
Type=simple
User=$SERVICE_USER
Group=$SERVICE_USER
WorkingDirectory=/var/lib/log-sender
ExecStart=/usr/local/bin/log-sender service --config-file $CONFIG_FILE
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# Enable and start service
sudo systemctl daemon-reload
sudo systemctl enable log-sender
sudo systemctl start log-sender

echo "Log-sender setup complete!"
sudo systemctl status log-sender
```

### Multi-Environment Configuration

```bash
# Development environment (Holochain dev setup)
export LOG_SENDER_ENDPOINT="http://dev-log-collector:8787"
export LOG_SENDER_UNYT_PUB_KEY="uhCAk..."  # Replace with your actual Holochain agent key
export LOG_SENDER_REPORT_INTERVAL_SECONDS="60"
export LOG_SENDER_REPORT_PATHS="/var/log/holochain/dev-conductor,/var/log/holochain/dev-apps"

# Production environment (Holochain production setup)
export LOG_SENDER_ENDPOINT="https://prod-log-collector.example.com:8787"
export LOG_SENDER_UNYT_PUB_KEY="uhCAk..."  # Replace with your actual Holochain agent key
export LOG_SENDER_REPORT_INTERVAL_SECONDS="300"
export LOG_SENDER_REPORT_PATHS="/var/log/holochain/prod-conductor,/var/log/holochain/prod-apps"
export LOG_SENDER_CONDUCTOR_CONFIG_PATHS="/etc/holochain/prod-conductor.toml"

# Initialize based on environment
log-sender init --config-file /etc/log-sender/config.json
```

### Monitoring Script

```bash
#!/bin/bash
# Log-sender health monitoring script

CONFIG_FILE="/etc/log-sender/config.json"
SERVICE_NAME="log-sender"

# Check service status
if ! systemctl is-active --quiet $SERVICE_NAME; then
    echo "ERROR: $SERVICE_NAME is not running"
    systemctl status $SERVICE_NAME
    exit 1
fi

# Check configuration
if ! jq empty $CONFIG_FILE 2>/dev/null; then
    echo "ERROR: Invalid configuration file"
    exit 1
fi

# Check log directories
DRONE_ID=$(jq -r '.drone_id' $CONFIG_FILE)
echo "INFO: Log-sender is running with drone_id: $DRONE_ID"

# Check recent activity (last 5 minutes)
REPORT_PATHS=$(jq -r '.report_path_list[]' $CONFIG_FILE)
for path in $REPORT_PATHS; do
    if [[ -d "$path" ]]; then
        RECENT_FILES=$(find "$path" -name "*.jsonl" -newermt "5 minutes ago" 2>/dev/null | wc -l)
        echo "INFO: $RECENT_FILES recent log files in $path"
    else
        echo "WARNING: Log directory $path does not exist"
    fi
done

echo "INFO: Log-sender health check completed"
```

This guide provides comprehensive information for system administrators deploying and managing log-sender in production environments. For additional support, consult the troubleshooting section or review service logs for specific error messages.
